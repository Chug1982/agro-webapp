<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Обрисовка поля — Яндекс Карта</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=0e0eb37c-e2f1-4318-ac80-0bb98822bc8f" type="text/javascript"></script>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { width: 100%; height: 100%; }
    #done-btn {
      position: absolute;
      top: 10px; left: 50%; transform: translateX(-50%);
      padding: 10px 20px;
      background: white; border: 1px solid #ccc;
      font-size: 16px; z-index: 1000; cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="done-btn">? Завершить</div>
  <div id="map"></div>

  <script>
    ymaps.ready(init);

    let myPolygon;

    function init() {
      const map = new ymaps.Map("map", {
        center: [56.85, 45.05], // Пример: Чувашия
        zoom: 11,
        type: 'yandex#satellite',
        controls: ['zoomControl']
      });

      map.behaviors.enable('default');

      // Создание пустого полигона
      myPolygon = new ymaps.Polygon([], {}, {
        editorDrawingCursor: "crosshair",
        fillColor: '#00FF0088',
        strokeColor: "#0000FF",
        strokeWidth: 3,
        opacity: 0.5
      });

      map.geoObjects.add(myPolygon);

      myPolygon.editor.startDrawing();

      // Кнопка завершения
      document.getElementById('done-btn').onclick = function () {
        if (!myPolygon.geometry.getCoordinates()[0].length) {
          alert("Сначала обрисуйте поле!");
          return;
        }

        // Преобразование координат в GeoJSON
        const geojson = {
          type: "Feature",
          geometry: {
            type: "Polygon",
            coordinates: [myPolygon.geometry.getCoordinates()[0]]
          },
          properties: {}
        };

        const jsonStr = JSON.stringify(geojson);
        if (window.Telegram.WebApp) {
          Telegram.WebApp.sendData(jsonStr);
          Telegram.WebApp.close();
        } else {
          alert("GeoJSON:\n" + jsonStr);
        }
      };
    }
  </script>
</body>
</html>
