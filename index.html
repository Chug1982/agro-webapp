<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–û–±—Ä–∏—Å–æ–≤–∫–∞ –ø–æ–ª—è ‚Äî –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- –í—Å—Ç–∞–≤—å —Å–≤–æ–π API-–∫–ª—é—á –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç -->
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=0e0eb37c-e2f1-4318-ac80-0bb98822bc8f" type="text/javascript"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { width: 100vw; height: 100vh; }
    #done-btn, #reset-btn {
      position: absolute;
      top: 10px;
      padding: 10px 20px;
      background: white;
      border: 1px solid #ccc;
      font-size: 16px;
      z-index: 1000;
      cursor: pointer;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
    }
    #done-btn { left: 50%; transform: translateX(-60px); }
    #reset-btn { left: 50%; transform: translateX(60px); }
    #hint {
      position: absolute;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      padding: 7px 18px;
      z-index: 1000;
      border-radius: 8px;
      border: 1px solid #eee;
      font-size: 15px;
      color: #333;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      user-select: none;
    }
  </style>
</head>
<body>
  <div id="done-btn">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å</div>
  <div id="reset-btn">üîÑ –°–±—Ä–æ—Å–∏—Ç—å</div>
  <div id="hint">–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å –ø–æ–ª–µ. –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ ‚Äî –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ç–æ—á–∫—É.</div>
  <div id="map"></div>

  <script>
    // –û—Ç–ª–∞–¥–∫–∞: –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Telegram WebApp API
    console.log("Telegram =", window.Telegram);
    console.log("Telegram.WebApp =", window.Telegram?.WebApp);

    let myPolygon, map;

    ymaps.ready(init);

    function init() {
      ymaps.geolocation.get().then(function (res) {
        const userCoords = res.geoObjects.get(0).geometry.getCoordinates();
        createMap(userCoords);
      }, function () {
        createMap([55.7558, 37.6173]);
      });
    }

    function createMap(centerCoords) {
      map = new ymaps.Map("map", {
        center: centerCoords,
        zoom: 13,
        type: 'yandex#hybrid',
        controls: ['zoomControl']
      });

      map.behaviors.enable('default');

      createPolygon();

      document.getElementById('done-btn').onclick = sendPolygon;
      document.getElementById('reset-btn').onclick = resetPolygon;
    }

    function createPolygon() {
      if (myPolygon) {
        map.geoObjects.remove(myPolygon);
      }
      myPolygon = new ymaps.Polygon([], {}, {
        editorDrawingCursor: "crosshair",
        fillColor: '#00FF0088',
        strokeColor: "#0000FF",
        strokeWidth: 3,
        opacity: 0.5
      });
      map.geoObjects.add(myPolygon);
      myPolygon.editor.startDrawing();
    }

    function resetPolygon() {
      createPolygon();
    }

    function sendPolygon() {
      const coords = myPolygon.geometry.getCoordinates()[0];
      if (!coords || coords.length < 3) {
        alert("–°–Ω–∞—á–∞–ª–∞ –æ–±—Ä–∏—Å—É–π—Ç–µ –ø–æ–ª–µ (–º–∏–Ω–∏–º—É–º 3 —Ç–æ—á–∫–∏)!");
        return;
      }
      const geojson = {
        type: "Feature",
        geometry: {
          type: "Polygon",
          coordinates: [coords]
        },
        properties: {}
      };
      const jsonStr = JSON.stringify(geojson);
      console.log("–ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ Telegram:", jsonStr);
      if (window.Telegram && Telegram.WebApp) {
        Telegram.WebApp.sendData(jsonStr);
        Telegram.WebApp.close();
        console.log("–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ Telegram.WebApp.sendData");
      } else {
        alert("Telegram WebApp API –Ω–µ –Ω–∞–π–¥–µ–Ω! (–í—ã –Ω–µ –≤ Telegram?)\nGeoJSON:\n" + jsonStr);
        console.log("Telegram.WebApp –Ω–µ –Ω–∞–π–¥–µ–Ω!");
      }
    }
  </script>
</body>
</html>
